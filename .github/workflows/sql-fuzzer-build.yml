name: SQL Fuzzer Build Test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-sql-fuzzer:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout autarkie repository
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Clone datafusion-sqlparser-rs
      run: |
        cd /tmp
        git clone https://github.com/apache/datafusion-sqlparser-rs
        cd datafusion-sqlparser-rs
        git reset --hard 7703fd0d3180c2e8b347c11394084c3a2458be14

    - name: Add autarkie as dependency to sqlparser
      run: |
        cd /tmp/datafusion-sqlparser-rs
        cargo add autarkie --path ${{ github.workspace }}/autarkie --features derive --features afl

    - name: Derive Grammar macro for AST
      run: |
        cd /tmp/datafusion-sqlparser-rs
        rg "Serialize" --files-with-matches | xargs -r sed -i 's/Serialize,/Serialize, autarkie::Grammar,/g'

    - name: Modify grammar for fuzzing
      run: |
        cd /tmp/datafusion-sqlparser-rs
        sed -i '390d' ./src/ast/mod.rs
        rg "panic!\(\"unexpected quote style\"\)" --files-with-matches | xargs -r sed -i 's/panic!("unexpected quote style")/write!(f, "\\\"{}\\\"", value::escape_quoted_string(\&self.value, \'"\'))/g'

    - name: Build instrumented sqlparser
      run: |
        cd /tmp/datafusion-sqlparser-rs
        cargo build --features serde

    - name: Create fuzzer project
      run: |
        cd /tmp
        mkdir sql-fuzzer
        cd sql-fuzzer
        cargo init

    - name: Add fuzzer dependencies
      run: |
        cd /tmp/sql-fuzzer
        cargo add serde --features derive
        cargo add autarkie --path ${{ github.workspace }}/autarkie --features derive --features afl
        cargo add sqlparser --path /tmp/datafusion-sqlparser-rs --features serde

    - name: Create fuzzer code
      run: |
        cd /tmp/sql-fuzzer
        cat > src/main.rs << 'EOF'
        use sqlparser::ast::Statement;

        /// A list of statements to execute
        /// This will be given to our fuzzing harness
        #[derive(serde::Serialize, serde::Deserialize, autarkie::Grammar, Debug, Clone)]
        pub struct FuzzData {
            statements: Vec<Statement>,
        }

        // We need to render the internal type to a harness supported format.
        // Autarkie's macro allows us to provide a custom render function.
        // the sqlparser package provides a ``to_string`` function which we can
        // use to render the internal representation into text SQL.
        autarkie::fuzz_afl!(FuzzData, |data: &FuzzData| -> Vec<u8> {
            let mut ret = vec![];
            for statement in &data.statements {
                ret.extend(statement.to_string().as_bytes())
            }
            ret
        });
        EOF

    - name: Build SQL fuzzer
      run: |
        cd /tmp/sql-fuzzer
        cargo build --release

    - name: Verify fuzzer binary exists
      run: |
        ls -lh /tmp/sql-fuzzer/target/release/sql-fuzzer
        echo "SQL fuzzer built successfully!"
